# Техническая документация проекта "ML in Sports"

## Оглавление
1. [Общее описание проекта](#1-общее-описание-проекта)
2. [Архитектура проекта](#2-архитектура-проекта)
3. [Технологический стек](#3-технологический-стек)
4. [Описание модулей](#4-описание-модулей)

## 1. Общее описание проекта

### 1.1. Цель проекта
Создание комплексной системы анализа хоккейной статистики с использованием методов машинного обучения для:
- Оценки эффективности игроков
- Прогнозирования результатов матчей
- Расчета рейтингов команд и игроков
- Визуализации статистических данных

### 1.2. Задачи проекта
1. **Обработка данных**:
   - Сбор статистики матчей и игроков
   - Валидация и очистка данных
   - Преобразование данных в удобный для анализа формат

2. **Анализ данных**:
   - Расчет индивидуальных рейтингов игроков
   - Определение эффективности команд
   - Выявление ключевых факторов, влияющих на результат

3. **Прогнозирование**:
   - Предсказание результатов матчей
   - Оценка вероятности различных исходов
   - Анализ тенденций и трендов

4. **Визуализация**:
   - Создание интерактивных графиков
   - Построение информативных таблиц
   - Генерация отчетов

### 1.3. Входные данные
- Статистика матчей
- Данные об игроках
- Историческая информация о командах
- Результаты предыдущих встреч

### 1.4. Выходные данные
- Рейтинги команд и игроков
- Прогнозы на матчи
- Аналитические отчеты
- Визуализации статистики

## 2. Архитектура проекта

### 2.1. Общая структура
```
app/
├── src/                 # Логика анализа данных
│   ├── preprocessing.py # Предобработка данных
│   ├── models.py       # Модели данных
│   ├── method_bayesian.py # Байесовский анализ
│   └── generate_ratings_*.py # Генерация рейтингов
└── ui/                  # Пользовательский интерфейс
    ├── core/           # Ядро приложения
    ├── controllers/    # Контроллеры
    ├── models/         # Модели UI
    ├── views/          # Представления
    └── main.py         # Точка входа
```

### 2.2. Компоненты системы
1. **Модуль предобработки**:
   - Очистка данных
   - Валидация
   - Трансформация

2. **Аналитический модуль**:
   - Статистические расчеты
   - Машинное обучение
   - Прогнозирование

3. **Модуль визуализации**:
   - Графики
   - Таблицы
   - Дашборды

## 3. Парадигмы программирования

### 3.1. Объектно-ориентированное программирование
**Примеры использования**:
```python
class PlayerModel:
    def __init__(self, player_id, name, position):
        self.player_id = player_id
        self.name = name
        self.position = position
        self.statistics = {}

    def calculate_rating(self):
        # Расчет рейтинга игрока
        pass

class TeamModel:
    def __init__(self, team_id, name):
        self.team_id = team_id
        self.name = name
        self.players = []
        self.history = []
```

### 3.2. Функциональное программирование
**Примеры использования**:
```python
def calculate_elo_rating(team_rating, opponent_rating, result, K=32):
    expected = 1 / (1 + 10 ** ((opponent_rating - team_rating) / 400))
    actual = 1 if result == 'W' else 0 if result == 'L' else 0.5
    return team_rating + K * (actual - expected)

# Использование map и filter
players = list(filter(lambda x: x.position == 'forward', team.players))
ratings = list(map(lambda p: p.calculate_rating(), players))
```

## 4. Шаблоны проектирования

### 4.1. Singleton (Одиночка)
**Пример реализации**:
```python
class HockeyAnalyticsApp:
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
```

### 4.2. Factory Method (Фабричный метод)
**Пример реализации**:
```python
class ControllerFactory:
    @staticmethod
    def create_controller(controller_type):
        if controller_type == "home":
            return HomeController()
        elif controller_type == "stats":
            return StatsController()
```

### 4.3. Observer (Наблюдатель)
**Пример реализации**:
```python
class DataUpdateObserver:
    def update(self, data):
        self.refresh_view(data)

class DataModel:
    def __init__(self):
        self.observers = []

    def add_observer(self, observer):
        self.observers.append(observer)

    def notify_observers(self):
        for observer in self.observers:
            observer.update(self.data)
```

## 5. Принципы SOLID

### 5.1. Single Responsibility Principle
**Пример**:
```python
# Каждый класс имеет одну ответственность
class DataLoader:
    def load_data(self, file_path):
        pass

class DataValidator:
    def validate_data(self, data):
        pass

class DataTransformer:
    def transform_data(self, data):
        pass
```

### 5.2. Open/Closed Principle
**Пример**:
```python
class RatingCalculator:
    def calculate(self, data):
        pass

class EloRatingCalculator(RatingCalculator):
    def calculate(self, data):
        # Реализация ELO рейтинга
        pass

class BayesianRatingCalculator(RatingCalculator):
    def calculate(self, data):
        # Реализация байесовского рейтинга
        pass
```

## 6. Подробное описание модулей

### 6.1. preprocessing.py
**Назначение**: Предварительная обработка данных.

**Входные данные**:
- CSV файлы с сырыми данными
- Параметры обработки

**Выходные данные**:
- Очищенные и валидированные данные
- Логи обработки

**Основные функции**:
```python
def replace_data(folder_path):
    """
    Заменяет нулевые значения на NaN.
    
    Параметры:
        folder_path (str): Путь к папке с файлами
        
    Возвращает:
        None (файлы сохраняются на диск)
    """

def remove_invalid_games(df):
    """
    Удаляет некорректные игры.
    
    Параметры:
        df (DataFrame): Датафрейм с играми
        
    Возвращает:
        DataFrame: Очищенный датафрейм
    """
```

### 6.2. method_bayesian.py
**Назначение**: Реализация байесовского метода анализа.

**Входные данные**:
- Статистика матчей
- Параметры модели

**Выходные данные**:
- Вероятности исходов
- Рейтинги команд

**Ключевые функции**:
```python
def calculate_points(df, coefficient, amplua):
    """
    Расчет очков игрока.
    
    Формула:
    p_stat = ((stat + coefficient * games) ** 2) / games
    
    Параметры:
        df (DataFrame): Данные игрока
        coefficient (float): Коэффициент расчета
        amplua (int): Амплуа игрока
    """
```

### 6.3. models.py
Содержит основные модели данных и машинного обучения.

#### Ключевые классы:
- `PlayerModel`: Модель данных игрока
- `TeamModel`: Модель данных команды
- `GameModel`: Модель данных игры

### 6.4. generate_ratings_*.py
Модули для генерации различных типов рейтингов.

#### Реализованные методы:
- ELO рейтинг
- Интегральный метод
- Советский метод

### 6.5. UI Компоненты (ui/)

#### core/app.py
Основной класс приложения `HockeyAnalyticsApp`:
- Управление состоянием приложения
- Маршрутизация
- Инициализация компонентов

#### controllers/
Контроллеры для различных разделов:
- `HomeController`: Главная страница
- `StatsController`: Статистика
- `RankingsController`: Рейтинги
- `ChartsController`: Графики

#### views/
Представления для отображения данных:
- Таблицы статистики
- Графики и диаграммы
- Формы ввода данных

#### models/
Модели данных для UI:
- Структуры данных
- Бизнес-логика
- Валидация данных

## 7. Заключение

Проект представляет собой хорошо структурированное приложение для анализа хоккейной статистики, построенное с использованием современных практик разработки. Архитектура обеспечивает:
- Масштабируемость
- Поддерживаемость
- Тестируемость
- Расширяемость

Использование принципов SOLID и паттернов проектирования делает код чистым и понятным, а модульная структура позволяет легко добавлять новую функциональность.

## 8. Подробное описание файлов

### 8.1. Модуль preprocessing.py
**Назначение**: Предварительная обработка и подготовка данных для анализа.

**Основные функции и их описание**:
```python
def replace_data(folder_path):
    """
    Назначение: Замена нулевых значений на NaN во всех CSV файлах в указанной папке.
    Параметры:
        folder_path (str): Путь к папке с CSV файлами
    """

def re_format_file(folder_path):
    """
    Назначение: Перекодирование файлов в UTF-8
    Параметры:
        folder_path (str): Путь к папке с файлами
    Особенности:
        - Автоматическое определение исходной кодировки
        - Обработка ошибок кодирования
    """

def remove_invalid_games(df):
    """
    Назначение: Удаление некорректных игр из датасета
    Параметры:
        df (DataFrame): Датафрейм с данными игр
    Критерии удаления:
        - Игры с неверным количеством команд
        - Игры с недостаточным количеством данных
    """
```

**Ключевые особенности**:
- Автоматическое определение кодировки файлов
- Валидация данных по множеству критериев
- Логирование процесса обработки
- Сохранение промежуточных результатов

### 8.2. Модуль method_bayesian.py
**Назначение**: Реализация байесовского метода анализа для прогнозирования результатов матчей.

**Основные функции и их описание**:
```python
def calculate_points(df, coefficient, amplua):
    """
    Назначение: Расчет очков игрока с учетом амплуа
    Формула: p_stat = ((stat + coefficient * games) ** 2) / games
    Параметры:
        df (DataFrame): Данные игроков
        coefficient (float): Коэффициент для расчета
        amplua (int): Код амплуа игрока
    """

def calc_team_rating(df_compile, df_history, season_id=None, team_ids=None):
    """
    Назначение: Расчет рейтинга команд
    Особенности:
        - Учет сезона
        - Фильтрация по командам
        - Группировка статистики
    """

def predict_match_outcome(df, team_A_id, team_B_id, recent_games=5):
    """
    Назначение: Прогнозирование исхода матча
    Методология:
        - Анализ последних игр
        - Расчет вероятностей
        - Учет формы команд
    """
```

**Ключевые алгоритмы**:
1. Расчет рейтинга игроков:
   ```python
   p_stat = ((stat + coefficient * games) ** 2) / games
   ```
2. Байесовский анализ:
   - Использование предыдущих результатов
   - Учет последних игр
   - Корректировка вероятностей

### 8.3. Модуль models.py
**Назначение**: Определение основных моделей данных и их взаимодействий.

**Основные классы**:
```python
class PlayerModel:
    """
    Модель данных игрока
    Атрибуты:
        - ID
        - Имя
        - Амплуа
        - Статистика
    Методы:
        - Расчет рейтинга
        - Обновление статистики
    """

class TeamModel:
    """
    Модель данных команды
    Атрибуты:
        - ID
        - Название
        - Состав
        - История игр
    Методы:
        - Расчет командного рейтинга
        - Анализ формы
    """
```

### 8.4. Модуль generate_ratings_elo.py
**Назначение**: Реализация рейтинговой системы ELO.

**Основные функции**:
```python
def calculate_elo_rating(team_rating, opponent_rating, result, K=32):
    """
    Расчет рейтинга ELO
    Параметры:
        team_rating (float): Текущий рейтинг команды
        opponent_rating (float): Рейтинг соперника
        result (float): Результат матча (1 - победа, 0.5 - ничья, 0 - поражение)
        K (int): Коэффициент изменения рейтинга
    """
```

**Особенности реализации**:
- Динамическое обновление рейтингов
- Учет силы соперников
- Историческое отслеживание изменений

### 8.5. UI Компоненты

#### 8.5.1. core/app.py
**Назначение**: Основной класс приложения.

**Ключевые компоненты**:
```python
class HockeyAnalyticsApp:
    """
    Основной класс приложения
    Методы:
        - register_controller(): Регистрация контроллеров
        - setup(): Инициализация конфигурации
        - run(): Запуск приложения
    """
```

#### 8.5.2. controllers/
**Структура контроллеров**:
```python
class BaseController:
    """
    Базовый класс для всех контроллеров
    Методы:
        - initialize(): Инициализация
        - handle_input(): Обработка ввода
        - update_view(): Обновление представления
    """

class HomeController(BaseController):
    """
    Контроллер главной страницы
    Особенности:
        - Отображение общей статистики
        - Навигация по разделам
    """
```

#### 8.5.3. views/
**Компоненты представления**:
```python
class BaseView:
    """
    Базовый класс представления
    Методы:
        - render(): Отрисовка интерфейса
        - update(): Обновление данных
    """
```

### 8.6. Дополнительные файлы

#### 8.6.1. requirements.txt
```
streamlit==1.x.x
pandas==1.x.x
numpy==1.x.x
scikit-learn==1.x.x
matplotlib==3.x.x
plotly==5.x.x
```

#### 8.6.2. .gitignore
```
__pycache__/
*.pyc
.env
.venv/
data/raw/
```

## 9. Взаимодействие компонентов

### 9.1. Поток данных
1. Загрузка сырых данных
2. Предобработка (preprocessing.py)
3. Анализ данных (method_*.py)
4. Визуализация результатов (views/)

### 9.2. Процесс обработки запроса
1. Получение запроса (controllers/)
2. Обработка данных (models/)
3. Формирование ответа (views/)
4. Отображение результата (UI)

## 10. Рекомендации по развертыванию

### 10.1. Требования к системе
- Python 3.8+
- 8GB RAM
- 50GB свободного места

### 10.2. Установка
```bash
git clone <repository>
cd ML-in-sports
pip install -r requirements.txt
```

### 10.3. Запуск
```bash
streamlit run app/ui/main.py
```

## 11. Заключение

Проект представляет собой комплексное решение для анализа хоккейной статистики, построенное с использованием современных технологий и методологий разработки. Модульная архитектура и четкое разделение ответственности между компонентами обеспечивают легкость поддержки и расширения функциональности. 